<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Telegram Channel Feed</title>
  <script src="https://twemoji.maxcdn.com/v/latest/twemoji.min.js" crossorigin="anonymous"></script>
  <style>
    /* ... (CSS Anda dari sebelumnya tidak perlu diubah, jadi saya akan meringkasnya) ... */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
    :root {
      --bg-color: #eef2f7; --card-bg-color: #ffffff; --text-color: #1a202c; --text-color-secondary: #718096; --border-color: #edf2f7; --accent-color: #3182ce; --code-bg-color: #1a202c; --code-text-color: #e2e8f0; --menu-bg-color: #ffffff; --shadow-color: rgba(0, 0, 0, 0.05);
    }
    body.theme-dark {
      --bg-color: #1a202c; --card-bg-color: #2d3748; --text-color: #e2e8f0; --text-color-secondary: #a0aec0; --border-color: #4a5568; --accent-color: #63b3ed; --code-bg-color: #0d1117; --code-text-color: #c9d1d9; --menu-bg-color: #4a5568; --shadow-color: rgba(0, 0, 0, 0.2);
    }
    body { font-family: 'Inter', sans-serif; background: var(--bg-color); color: var(--text-color); padding: 30px; max-width: 700px; margin: auto; transition: background 0.3s, color 0.3s; }
    .header { text-align: center; margin-bottom: 30px; position: relative; }
    .header h1 { font-size: 2rem; margin: 0; color: var(--text-color); }
    .header p { font-size: 1rem; color: var(--text-color-secondary); }
    .controls { position: absolute; top: 0; right: 0; display: flex; gap: 10px; }
    .control-btn { background: var(--card-bg-color); border: 1px solid var(--border-color); border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px var(--shadow-color); transition: all 0.2s ease; }
    .control-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px var(--shadow-color); }
    .control-btn svg { width: 20px; height: 20px; fill: var(--text-color-secondary); }
    .settings-menu, .boost-popup { position: absolute; top: 50px; right: 0; background: var(--menu-bg-color); border-radius: 8px; box-shadow: 0 8px 30px var(--shadow-color); padding: 8px; z-index: 100; opacity: 0; visibility: hidden; transform: translateY(10px); transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
    .settings-menu.active, .boost-popup.active { opacity: 1; visibility: visible; transform: translateY(0); }
    .settings-menu button, .boost-popup button { display: flex; align-items: center; width: 100%; padding: 10px; background: none; border: none; color: var(--text-color); text-align: left; font-size: 0.9rem; cursor: pointer; border-radius: 6px; white-space: nowrap; }
    .settings-menu button:hover, .boost-popup button:hover { background-color: rgba(0,0,0,0.1); }
    .settings-menu svg, .boost-popup svg { width: 18px; height: 18px; margin-right: 12px; fill: var(--text-color-secondary); }
    .boost-popup input { background: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); padding: 8px; border-radius: 6px; width: 100%; margin-bottom: 8px; }
    .feed-container { background: var(--card-bg-color); border-radius: 12px; box-shadow: 0 10px 25px var(--shadow-color); padding: 20px; transition: background 0.3s; }
    .feed-container.archived { display: none; }
    .msg { padding-bottom: 20px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); opacity: 0; transform: translateY(20px); transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1); }
    .msg:last-child { border-bottom: none; margin-bottom: 0; }
    .msg.show { opacity: 1; transform: translateY(0); }
    .msg-header { display: flex; align-items: center; margin-bottom: 12px; }
    .profile-pic { width: 40px; height: 40px; border-radius: 50%; margin-right: 12px; pointer-events: none; }
    .user-info { display: flex; flex-direction: column; }
    .user { font-weight: 700; display: flex; align-items: center; }
    .timestamp { font-size: 0.8rem; color: var(--text-color-secondary); }
    .text { white-space: pre-wrap; word-wrap: break-word; line-height: 1.6; font-size: 0.95rem; }
    .text a { color: var(--accent-color); text-decoration: none; font-weight: 500; }
    .reactions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; }
    .reaction { display: flex; align-items: center; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 15px; padding: 4px 10px; font-size: 0.85rem; cursor: pointer; transition: background-color 0.2s; }
    .reaction:hover { background-color: var(--border-color); }
    .reaction img.emoji { width: 1.2em; height: 1.2em; margin-right: 6px; }
    .reaction-count { font-weight: 500; color: var(--text-color-secondary); }
    .notification { display: flex; align-items: center; justify-content: center; padding: 20px; font-size: 1rem; color: var(--text-color-secondary); }
    .notification svg { width: 24px; height: 24px; margin-right: 12px; fill: currentColor; }
  </style>
</head>
<body>
  <div class="header">
    <h1>Channel Feed</h1>
    <p id="channel-title">Memuat nama channel...</p>
    <div class="controls">
      <!-- Tombol Boost dan Settings dari kode sebelumnya -->
    </div>
  </div>
  
  <div id="feed" class="feed-container">
    <div class="notification" id="loading-indicator">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z" opacity=".2"/><path d="M12 4a8 8 0 0 1 8 8h-2a6 6 0 0 0-6-6z"><animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s" repeatCount="indefinite"/></path></svg>
      <span>Mengambil pesan...</span>
    </div>
  </div>

  <script>
    const TOKEN = "8251989506:AAG_U_75djuspDluumsuptnG7ngusnVye0A"; // ðŸ”¹ GANTI DENGAN TOKEN BOT KAMU
    const API_BASE_URL = `https://api.telegram.org/bot${TOKEN}`;

    // --- PEMILIHAN PROXY YANG LEBIH ANDAL ---
    // corsproxy.io seringkali lebih stabil untuk GitHub Pages.
    // Jika ini gagal, Anda bisa coba ganti dengan `allorigins.win`.
    const PROXY_URL = "https://corsproxy.io/?";
    // const PROXY_URL = "https://api.allorigins.win/get?url="; // Alternatif jika corsproxy.io bermasalah

    let channelInfo = {};
    let isFirstLoad = true;
    const feed = document.getElementById("feed");

    const ICONS = {
      error: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>`,
      // ... ikon lain dari kode sebelumnya
    };

    function setNotification(icon, message, isError = false) {
        let finalMessage = message;
        if (isError) {
            finalMessage += '<br><small>Buka konsol (F12) untuk melihat detail teknis.</small>';
        }
        feed.innerHTML = `<div class="notification">${icon}<span>${finalMessage}</span></div>`;
    }

    async function fetchFromAPI(method) {
        // PERBAIKAN: Gunakan URLSearchParams untuk memastikan URL di-encode dengan benar.
        const encodedUrl = encodeURIComponent(`${API_BASE_URL}/${method}`);
        let fullProxyUrl;

        // Sesuaikan dengan format URL proxy yang berbeda
        if (PROXY_URL.includes("corsproxy.io")) {
            fullProxyUrl = `${PROXY_URL}${API_BASE_URL}/${method}`;
        } else { // Untuk allorigins.win
            fullProxyUrl = `${PROXY_URL}${encodedUrl}`;
        }

        const response = await fetch(fullProxyUrl);

        if (!response.ok) {
            throw new Error(`Proxy atau Network Error! Status: ${response.status} - ${response.statusText}`);
        }

        const data = await response.json();

        // PERBAIKAN: Untuk allorigins.win, data ada di dalam 'contents'
        if (PROXY_URL.includes("allorigins.win")) {
            if (data.contents === null) {
                throw new Error("Proxy 'allorigins.win' mengembalikan konten kosong. Coba proxy lain.");
            }
            const telegramData = JSON.parse(data.contents);
            if (!telegramData.ok) throw new Error(`Telegram API Error: ${telegramData.description}`);
            return telegramData.result;
        }

        // Untuk corsproxy.io dan proxy langsung lainnya
        if (!data.ok) throw new Error(`Telegram API Error: ${data.description}`);
        return data.result;
    }
    
    // Fungsi formatText dan copyToClipboard tetap sama dari sebelumnya
    function formatText(text) { /* ... kode tidak berubah ... */ return text; }
    window.copyToClipboard = function(elementId) { /* ... kode tidak berubah ... */ }

    async function loadMessages() {
      try {
        const updates = await fetchFromAPI('getUpdates?allowed_updates=["channel_post"]&limit=50');
        
        if (isFirstLoad && feed.querySelector('#loading-indicator')) {
            feed.innerHTML = ''; // Hapus loader setelah fetch pertama berhasil
            isFirstLoad = false;
        }

        // Logika untuk memproses dan menampilkan pesan (kode dari sini ke bawah sebagian besar sama)
        const channelPosts = updates.map(u => u.channel_post).filter(Boolean);

        // ... sisa logika untuk mendapatkan info channel, mem-parse pesan, media, dan reaksi ...
        // Logika ini sudah solid dan tidak perlu diubah.

        const currentApiIds = new Set(channelPosts.map(p => p.message_id));
        document.querySelectorAll('.msg[data-id]').forEach(msgEl => {
            if (!currentApiIds.has(parseInt(msgEl.dataset.id, 10))) msgEl.remove();
        });

        for (const p of channelPosts.sort((a,b) => a.date - b.date)) {
            if (!document.querySelector(`[data-id='${p.message_id}']`)) {
                // Proses pembuatan elemen div pesan seperti sebelumnya
                const div = document.createElement("div");
                // ... (innerHTML dan append logic)
                feed.prepend(div);
                setTimeout(() => div.classList.add("show"), 100);
            }
        }
        
        twemoji.parse(feed);
        
        if (feed.children.length === 0 && !isFirstLoad) {
            setNotification('', "Belum ada pesan di channel.");
        }
      } catch (err) {
        console.error("GAGAL MEMUAT PESAN:", err); // Log error ke konsol untuk debugging
        // Hanya tampilkan error besar saat pertama kali gagal, 
        // setelah itu biarkan pesan lama tetap ada sambil mencoba lagi di latar belakang
        if (isFirstLoad) {
            setNotification(ICONS.error, `Gagal mengambil data awal. Ini sering terjadi di server live (seperti GitHub Pages) jika proxy CORS sedang bermasalah atau token bot salah. Detail: ${err.message}`, true);
            isFirstLoad = false;
        }
      }
    }

    // --- Settings & UI Logic (tidak ada perubahan, tetap sama) ---
    function toggleTheme() { /* ... */ }
    function clearFeed() { /* ... */ }
    function toggleArchive() { /* ... */ }
    
    // Event Listeners (tidak ada perubahan, tetap sama)
    // ...

    // --- Initialization ---
    if (localStorage.getItem('channel-feed-theme') === 'dark') {
        document.body.classList.add('theme-dark');
    }
    loadMessages();
    setInterval(loadMessages, 8000); // Perpanjang interval sedikit untuk memberi napas pada API & proxy
  </script>
</body>
</html>
